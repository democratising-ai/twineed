<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twine Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1>Twine Workshop</h1>
            <p>Collaborative interactive fiction editor</p>
            <div class="login-box">
                <div class="error-message" id="loginError"></div>

                <!-- Login View -->
                <div id="loginView" class="auth-view active">
                    <button type="button" class="btn btn-google" id="googleSignInBtn">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                    </button>

                    <div class="auth-divider">
                        <span>or</span>
                    </div>

                    <form id="loginForm">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <button type="submit" class="btn btn-primary">Sign In</button>
                        <button type="button" class="btn-link" id="forgotPasswordBtn">Forgot password?</button>
                    </form>

                    <div class="auth-footer">
                        <span>Don't have an account?</span>
                        <button type="button" class="btn-link" id="showRegisterBtn">Sign up</button>
                    </div>
                </div>

                <!-- Register View -->
                <div id="registerView" class="auth-view">
                    <form id="registerForm">
                        <input type="email" id="registerEmail" placeholder="Email" required>
                        <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" required minlength="6">
                        <input type="password" id="registerPasswordConfirm" placeholder="Confirm password" required minlength="6">
                        <button type="submit" class="btn btn-primary">Create Account</button>
                    </form>

                    <div class="auth-footer">
                        <span>Already have an account?</span>
                        <button type="button" class="btn-link" id="backToLoginBtn">Sign in</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app">
        <!-- Top Toolbar -->
        <header class="toolbar">
            <div class="toolbar-left">
                <button class="toolbar-btn" id="backBtn" title="Back to stories">
                    <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="toolbar-divider"></div>
                <h1 class="story-title" id="storyTitle">Story Title</h1>
            </div>
            <div class="toolbar-center">
                <button class="toolbar-btn" id="zoomOutBtn" title="Zoom out">
                    <svg viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/></svg>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="toolbar-btn" id="zoomInBtn" title="Zoom in">
                    <svg viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6M7 10h6"/></svg>
                </button>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" id="addPassageBtn" title="Add passage">
                    <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Passage</span>
                </button>
                <button class="toolbar-btn" id="playBtn" title="Play story">
                    <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    <span>Play</span>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn menu-trigger" id="menuBtn">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                </button>
                <div class="dropdown-menu" id="storyMenu">
                    <button class="menu-item" id="renameStoryBtn">Rename Story</button>
                    <button class="menu-item" id="duplicateStoryBtn">Duplicate Story</button>
                    <div class="menu-divider"></div>
                    <button class="menu-item" id="exportStoryBtn">Export Story...</button>
                    <div class="menu-divider"></div>
                    <button class="menu-item danger" id="deleteStoryBtn">Delete Story</button>
                </div>
            </div>
        </header>

        <!-- Library View -->
        <div class="library-view" id="libraryView">
            <div class="library-header">
                <div class="library-title">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <h2>Stories</h2>
                </div>
                <div class="library-actions">
                    <button class="btn btn-secondary" id="importBtn">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                        Import
                    </button>
                    <button class="btn btn-primary" id="newStoryBtn">
                        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                        New Story
                    </button>
                    <button class="btn btn-ghost" id="logoutBtn" title="Logout">
                        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    </button>
                </div>
            </div>
            <div class="stories-list" id="storiesList">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Canvas View -->
        <div class="canvas-view" id="canvasView">
            <div class="canvas-container" id="canvasContainer">
                <svg class="connections-layer" id="connectionsLayer"></svg>
                <div class="passages-layer" id="passagesLayer"></div>
            </div>
        </div>
    </div>

    <!-- Passage Editor Modal -->
    <div class="modal-overlay" id="passageModal">
        <div class="passage-editor">
            <div class="passage-editor-header">
                <input type="text" class="passage-name-input" id="passageNameInput" placeholder="Untitled Passage">
                <div class="passage-editor-actions">
                    <button class="icon-btn" id="previewPassageBtn" title="Preview this passage">
                        <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                    <button class="icon-btn" id="setStartPassageBtn" title="Set as starting passage">
                        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    </button>
                    <button class="icon-btn" id="deletePassageBtn" title="Delete passage">
                        <svg viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                    </button>
                    <button class="icon-btn close-btn" id="closePassageBtn" title="Close">
                        <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
            <textarea class="passage-content-input" id="passageContentInput" placeholder="Write your passage content here. Use [[Passage Name]] to create links to other passages."></textarea>
            <div class="passage-editor-footer">
                <div class="syntax-hints">
                    <div class="hint-section">
                        <strong>Links:</strong> <code>[[Passage Name]]</code> or <code>[[Display Text|Passage Name]]</code> or <code>[[Text->Passage]]</code>
                    </div>
                    <div class="hint-section">
                        <strong>Markup:</strong> <code>**bold**</code> <code>//italic//</code> <code>__underline__</code> <code>~~strikethrough~~</code>
                    </div>
                    <div class="hint-section">
                        <strong>Variables (Harlowe):</strong> <code>(set: $var to "value")</code> <code>(if: $var)[text]</code> <code>(print: $var)</code>
                    </div>
                    <div class="hint-section">
                        <strong>Variables (SugarCube):</strong> <code>&lt;&lt;set $var = "value"&gt;&gt;</code> <code>&lt;&lt;if $var&gt;&gt;...&lt;&lt;endif&gt;&gt;</code>
                    </div>
                    <div class="hint-section">
                        <strong>Media:</strong> <code>[img[image.png]]</code> <code>[audio[sound.mp3]]</code> <code>[video[video.mp4]]</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Story Modal -->
    <div class="modal-overlay" id="newStoryModal">
        <div class="modal">
            <h3>Create New Story</h3>
            <form id="newStoryForm">
                <input type="text" id="newStoryTitle" placeholder="Story title" required>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelNewStory">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <h3>Rename Story</h3>
            <form id="renameForm">
                <input type="text" id="renameTitle" placeholder="New title" required>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRename">Cancel</button>
                    <button type="submit" class="btn btn-primary">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Duplicate Modal -->
    <div class="modal-overlay" id="duplicateModal">
        <div class="modal">
            <h3>Duplicate Story</h3>
            <form id="duplicateForm">
                <input type="text" id="duplicateTitle" placeholder="New title" required>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelDuplicate">Cancel</button>
                    <button type="submit" class="btn btn-primary">Duplicate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h3>Import Story</h3>
            <p class="modal-description">Import from Twine HTML archive, Twee (.tw, .twee), or JSON backup files.</p>
            <form id="importForm">
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" accept=".html,.htm,.tw,.twee,.json" required>
                    <div class="file-input-display">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                        <span>Choose a Twine file (.html, .tw, .twee, .json)</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelImport">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal export-modal">
            <h3>Export Story</h3>
            <p class="modal-description">Choose an export format:</p>
            <div class="export-options">
                <button class="export-option" id="exportTwineArchive">
                    <div class="export-option-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <div class="export-option-info">
                        <strong>Twine Archive (.html)</strong>
                        <span>Import into Twine 2 editor or other tools</span>
                    </div>
                </button>
                <button class="export-option" id="exportPlayable">
                    <div class="export-option-icon">
                        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    </div>
                    <div class="export-option-info">
                        <strong>Playable HTML (.html)</strong>
                        <span>Self-contained playable story file</span>
                    </div>
                </button>
                <button class="export-option" id="exportTwee">
                    <div class="export-option-icon">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                    </div>
                    <div class="export-option-info">
                        <strong>Twee 3 (.twee)</strong>
                        <span>Plain text format for version control</span>
                    </div>
                </button>
                <button class="export-option" id="exportJson">
                    <div class="export-option-icon">
                        <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
                    </div>
                    <div class="export-option-info">
                        <strong>JSON Backup (.json)</strong>
                        <span>Full data backup with all metadata</span>
                    </div>
                </button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelExport">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Play Modal -->
    <div class="modal-overlay" id="playModal">
        <div class="play-container">
            <button class="play-close" id="closePlayBtn">
                <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div class="play-content" id="playContent"></div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotPasswordModal">
        <div class="modal">
            <h3>Reset Password</h3>
            <p class="modal-description">Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgotPasswordForm">
                <input type="email" id="forgotEmail" placeholder="Email address" required>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelForgotPassword">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script type="module" src="js/app.js"></script>
</body>
</html>
